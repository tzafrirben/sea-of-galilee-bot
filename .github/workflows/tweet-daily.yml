name: Daily Tweet

on:
  schedule:
    - cron: "40 14 * * *" # Run daily at 14:40 UTC (after update)
  workflow_dispatch:

jobs:
  tweet:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: "24"

      - name: Install Dependencies
        run: npm ci

      - name: Send Tweet
        id: send_tweet
        env:
          UPPER_RED_LINE: ${{ vars.UPPER_RED_LINE }}
          LOWER_RED_LINE: ${{ vars.LOWER_RED_LINE }}
          BLACK_LINE: ${{ vars.BLACK_LINE }}
          TWITTER_APP_KEY: ${{ secrets.TWITTER_APP_KEY }}
          TWITTER_APP_SECRET: ${{ secrets.TWITTER_APP_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
        run: |
          npm run tweet:daily

      - name: Commit state update
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add last_tweet.txt
          # Only commit if there are changes (i.e. if tweet was sent and file updated)
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update last tweet state" && git push)
